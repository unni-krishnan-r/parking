{% extends 'base.html' %}

{% block content %}
<div class="relative h-full w-full bg-gray-900">
    <!-- 1. Map Container -->
    <div id="map" class="absolute inset-0 z-0" style="height: 100vh; width: 100vw;"></div>
</div>

<!-- 2. Search & Filter Overlay (Fixed Top) -->
<div class="fixed top-6 left-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none">
    <!-- Search Bar -->
    <div
        class="bg-surface/95 backdrop-blur-md border border-border rounded-full p-1 shadow-2xl flex items-center pointer-events-auto">
        <div class="w-10 h-10 flex items-center justify-center text-gray-400 ml-1">
            <i class="fas fa-search"></i>
        </div>
        <input type="text" placeholder="Find a parking spot..."
            class="bg-transparent border-none text-white focus:outline-none w-full h-10 text-sm placeholder-gray-500"
            onclick="showRecentSearches()">
        <div class="w-10 h-10 flex items-center justify-center text-accent border-l border-gray-700">
            <i class="fas fa-microphone"></i>
        </div>
    </div>

    <!-- Category Pills -->
    <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide pointer-events-auto">
        <button class="px-4 py-2 rounded-full bg-accent text-black text-xs font-bold shadow-lg whitespace-nowrap">Near
            Me</button>
        <button
            class="px-4 py-2 rounded-full bg-surface/90 border border-border text-white text-xs font-bold shadow-lg whitespace-nowrap backdrop-blur-sm">Top
            Rated</button>
        <button
            class="px-4 py-2 rounded-full bg-surface/90 border border-border text-white text-xs font-bold shadow-lg whitespace-nowrap backdrop-blur-sm">Lowest
            Price</button>
        <button
            class="px-4 py-2 rounded-full bg-surface/90 border border-border text-white text-xs font-bold shadow-lg whitespace-nowrap backdrop-blur-sm">Covered</button>
    </div>
</div>

<!-- 3. Preview Card (Fixed Bottom) -->
<div id="preview-card"
    class="fixed bottom-24 left-4 right-4 z-[100] transform translate-y-[150%] transition-transform duration-300 ease-out">
    <div
        class="bg-surface border border-border rounded-3xl p-5 shadow-2xl flex flex-col gap-4 relative w-full max-w-md mx-auto">
        <!-- Close Button -->
        <button onclick="closePreview()"
            class="absolute -top-3 -right-3 w-8 h-8 bg-gray-800 rounded-full border border-gray-600 flex items-center justify-center text-white shadow-lg z-50">
            <i class="fas fa-times text-xs"></i>
        </button>

        <!-- Header Info -->
        <div>
            <h3 id="card-name" class="font-bold text-white text-xl leading-tight mb-1">Loading...</h3>
            <p id="card-location" class="text-gray-400 text-sm">Location details...</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 mt-1">
            <!-- Navigate Button -->
            <button
                class="flex-1 bg-gray-700 hover:bg-gray-600 text-blue-400 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-colors">
                <i class="fas fa-location-arrow"></i>
                <span>Navigate</span>
            </button>

            <!-- Book Now Button -->
            <a id="card-btn" href="#"
                class="flex-1 bg-lime-600 hover:bg-lime-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-colors shadow-lg shadow-lime-900/20">
                <i class="fas fa-calendar-check"></i>
                <span>Book Now</span>
            </a>
        </div>
    </div>
    <span class="flex items-center"><i class="fas fa-star text-yellow-500 mr-1"></i> <span
            id="card-rating">4.5</span></span>
    <span id="card-distance">0.5 km</span>
</div>
</div>

<div class="flex justify-between items-end">
    <div>
        <span class="text-xs text-gray-500 block uppercase tracking-wider">Available</span>
        <span id="card-slots" class="text-accent font-bold text-lg">--</span>
    </div>
    <a id="card-btn" href="#"
        class="bg-accent hover:bg-yellow-500 text-black font-bold px-6 py-2 rounded-xl text-sm shadow-lg transition-colors">
        View Details
    </a>
</div>
</div>
</div>
</div>

<!-- Geo-Locate Button -->
<button onclick="locateUser()"
    class="fixed bottom-28 right-4 z-[90] w-12 h-12 bg-surface border border-border rounded-full flex items-center justify-center text-white shadow-lg active:scale-95 transition-transform hover:text-accent">
    <i class="fas fa-crosshairs text-lg"></i>
</button>

<!-- Styles & Scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* Custom Marker Badge */
    .price-badge {
        background-color: var(--accent-color);
        color: black;
        font-weight: 800;
        font-size: 12px;
        width: 40px !important;
        height: 40px !important;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        transition: transform 0.2s;
    }

    .marker-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .marker-wrapper.selected {
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        transform: scale(1.1);
        z-index: 1000;
    }

    .marker-wrapper.selected .price-badge {
        box-shadow: none;
        /* Remove inner shadow when selected */
    }

    /* Hide scrollbar */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
</style>

<script>
    // Initialize Map (Mimic Google Maps Dark/Silver)
    var map = L.map('map', { zoomControl: false }).setView([10.0271, 76.3082], 13);

    // CartoDB Dark Matter (High contrast)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    var userMarker = null;

    // Fetch & Plot Markers
    fetch('/api/nearby-parking?lat=10.0271&lon=76.3082')
        .then(response => response.json())
        .then(data => {
            data.zones.forEach(zone => {
                const markerId = `marker-${zone.id}`;

                var icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div id="${markerId}" class="marker-wrapper">
                             <div class="price-badge">â‚¹${zone.price}</div>
                           </div>`,
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });

                var marker = L.marker([zone.lat, zone.lon], { icon: icon }).addTo(map);

                // On Click -> Highlight Marker + Open Preview
                marker.on('click', () => {
                    // Deselect others
                    document.querySelectorAll('.marker-wrapper').forEach(el => el.classList.remove('selected'));
                    // Select current
                    const el = document.getElementById(markerId);
                    if (el) el.classList.add('selected');

                    openPreview(zone);
                    map.flyTo([zone.lat, zone.lon], 15, { paddingBottomRight: [0, 200] });
                });
            });
        });

    function openPreview(zone) {
        document.getElementById('card-name').innerText = zone.name;
        // Mock location for now as it's not in API response yet, or reuse logic
        document.getElementById('card-location').innerText = zone.distance ? `${zone.distance} km away` : "Nearby";

        document.getElementById('card-btn').href = `/book/${zone.id}`;

        const card = document.getElementById('preview-card');
        card.classList.remove('translate-y-[150%]', 'hidden');
        card.classList.add('translate-y-0');
    }

    function closePreview() {
        const card = document.getElementById('preview-card');
        card.classList.add('translate-y-[150%]');
        // Optional: clear selection
        document.querySelectorAll('.marker-wrapper').forEach(el => el.classList.remove('selected'));
    }

    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                if (userMarker) map.removeLayer(userMarker);

                // Blue Pulse Dot
                var dotIcon = L.divIcon({
                    className: 'user-dot',
                    html: '<div style="width:16px;height:16px;background:#3B82F6;border:2px solid white;border-radius:50%;box-shadow:0 0 0 10px rgba(59,130,246,0.3);"></div>',
                    iconSize: [20, 20]
                });
                userMarker = L.marker([lat, lon], { icon: dotIcon }).addTo(map);

                map.flyTo([lat, lon], 14);
            });
        }
    }

    // Auto-locate on load
    locateUser();
</script>
{% endblock %}